
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#F2F2F7" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Tasty Passport - Single Card Focus</title>
  <style>
    :root {
      --bg-app: #F2F2F7;
      --bg-card: #FFFFFF;
      --text-main: #1C1C1E;
      --text-sub: #8E8E93;
      --accent: #007AFF;
      --accent-gold: #FFD60A;
      --divider: #E5E5EA;
      --nav-height: 90px;
      --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --ease-smooth: cubic-bezier(0.25, 1, 0.5, 1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
      background-color: #000;
      height: 100vh; overflow: hidden;
      display: flex; justify-content: center;
    }

    .app-container {
      width: 100%; height: 100%;
      background: var(--bg-app);
      position: relative; overflow: hidden;
      display: flex; flex-direction: column;
    }
    @media (min-width: 500px) {
      .app-container { max-width: 414px; height: 92vh; border-radius: 40px; margin: auto; border: 8px solid #333; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    }

    /* SCROLL CONTENT */
    .view-content {
      flex: 1;
      min-height: 0;
      overflow-y: auto; overflow-x: hidden;
      padding-top: 70px; padding-bottom: 110px;
      scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
    }
    .view-content::-webkit-scrollbar { display: none; }

    /* HEADER */
    .app-header {
      position: absolute; top: 0; left: 0; right: 0; height: 60px;
      background: rgba(242, 242, 247, 0.85); backdrop-filter: blur(20px) saturate(180%);
      display: flex; align-items: flex-end; justify-content: space-between;
      padding: 0 20px 12px; z-index: 50; border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .app-title { font-size: 22px; font-weight: 700; color: var(--text-main); }

    /* SEARCH & CHIPS */
    .search-wrapper { padding: 10px 20px; position: sticky; top: 0; z-index: 40; background: var(--bg-app); }
    .search-input {
      width: 100%; background: #E3E3E8; border: none; padding: 12px 14px 12px 38px;
      border-radius: 12px; font-size: 16px; color: var(--text-main);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%238E8E93' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: 12px center; background-size: 16px;
    }
    .filter-scroll {
      display: flex; gap: 8px; padding: 5px 20px 20px; overflow-x: auto;
      scrollbar-width: none; scroll-snap-type: x mandatory;
    }
    .chip {
      padding: 8px 16px; background: #fff; border-radius: 20px;
      font-size: 14px; font-weight: 600; white-space: nowrap; color: var(--text-main);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); scroll-snap-align: start; cursor: pointer;
      transition: all 0.2s var(--ease-spring);
    }
    .chip.active { background: #1C1C1E; color: #fff; transform: scale(1.05); }

    /* MAP */
    .map-wrapper {
      margin: 0 20px 24px;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      background: #dfe8f3;
      border: 1px solid #d7d7de;
    }
    #explore-map { width: 100%; height: 230px; }
    .map-legend {
      position: absolute; bottom: 12px; left: 12px;
      background: rgba(255,255,255,0.95); padding: 10px 12px;
      border-radius: 12px; font-size: 12px; color: #3a3a3c;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12); border: 1px solid rgba(0,0,0,0.05);
      display: flex; align-items: center; gap: 8px;
    }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 4px rgba(0,122,255,0.15); }
    .map-toast {
      position: absolute; top: 12px; right: 12px;
      background: rgba(28,28,30,0.85); color: #fff; padding: 10px 12px;
      border-radius: 12px; font-size: 12px; font-weight: 600; letter-spacing: 0.01em;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.08);
    }

    /* VENUE CARDS */
    .section-title { font-size: 20px; font-weight: 700; margin: 10px 20px 15px; }
    .venue-card {
      background: #fff; margin: 0 20px 20px; border-radius: 16px;
      overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      position: relative; transition: transform 0.2s var(--ease-smooth); cursor: pointer;
    }
    .venue-card:active { transform: scale(0.97); }
    .venue-img { height: 160px; background: #ddd; position: relative; background-size: cover; background-position: center; }
    .card-qr-btn {
      position: absolute; bottom: 12px; right: 12px; width: 44px; height: 44px; border-radius: 50%;
      background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 10; border: 1px solid rgba(255,255,255,0.2);
    }
    .venue-details { padding: 14px 16px; }
    .venue-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .venue-name { font-size: 17px; font-weight: 600; color: var(--text-main); }
    .venue-meta { font-size: 13px; color: var(--text-sub); }

    /* WALLET CARDS & STACK */
    .section-subtitle { font-size: 13px; font-weight: 600; margin: 30px 20px 10px; color: var(--text-sub); text-transform: uppercase; }

    .wallet-card {
      margin: 0 20px 20px; padding: 24px; border-radius: 22px; color: white; position: relative; overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12); min-height: 210px; cursor: pointer;
      transition: transform 0.6s var(--ease-spring), margin-top 0.5s var(--ease-smooth), opacity 0.4s, filter 0.4s;
    }
    .wallet-card:active { transform: scale(0.97) !important; }
    
    .wallet-card.gold { background: linear-gradient(135deg, #3a3a3c, #1c1c1e); border: 1px solid rgba(255,214,10,0.4); }
    .wallet-card.blue { background: linear-gradient(135deg, #007AFF, #0056B3); }
    .wallet-card.green { background: linear-gradient(135deg, #34C759, #30B34D); }
    .wallet-card.red { background: linear-gradient(135deg, #FF3B30, #D70015); }
    .wallet-card.orange { background: linear-gradient(135deg, #FF9500, #FF5E3A); }
    .wallet-card.purple { background: linear-gradient(135deg, #AF52DE, #5856D6); }

    .card-header { display: flex; justify-content: space-between; margin-bottom: 24px; }
    .card-logo { width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 50%; display: grid; place-items: center; font-size: 24px; }
    .card-tier { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 8px; font-size: 10px; font-weight: 700; }
    .progress-track { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin: 12px 0 8px; }
    .progress-fill { height: 100%; background: #fff; border-radius: 3px; }

    .wallet-stack-wrapper { padding-bottom: 50px; perspective: 1000px; }
    .wallet-stack-wrapper:not(.expanded) .stacked-card { 
      margin-top: -175px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.1); 
    }
    .wallet-stack-wrapper:not(.expanded) .stacked-card:nth-child(1) { z-index: 10; transform: scale(1); }
    .wallet-stack-wrapper:not(.expanded) .stacked-card:nth-child(2) { z-index: 9; transform: scale(0.96) translateY(8px); filter: brightness(0.95); }
    .wallet-stack-wrapper:not(.expanded) .stacked-card:nth-child(3) { z-index: 8; transform: scale(0.92) translateY(16px); filter: brightness(0.9); }
    .wallet-stack-wrapper:not(.expanded) .stacked-card:nth-child(4) { z-index: 7; transform: scale(0.88) translateY(24px); filter: brightness(0.85); }
    .wallet-stack-wrapper:not(.expanded) .stacked-card:first-child { margin-top: 0; }
    .wallet-stack-wrapper.expanded .stacked-card { margin-top: 20px; transform: scale(1) translateY(0); filter: brightness(1); }

    /* PROFILE CONTENT */
    .profile-header { text-align: center; padding: 24px 20px; background: #fff; margin-bottom: 20px; }
    .profile-pic { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 12px; background-size: cover; background-position: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    .menu-list { background: #fff; margin: 0 20px 20px; border-radius: 16px; overflow: hidden; }
    .menu-list-item { padding: 18px; border-bottom: 1px solid var(--divider); display: flex; justify-content: space-between; align-items: center; font-size: 16px; color: var(--text-main); transition: background 0.2s; cursor: pointer; }
    .menu-list-item:active { background: #f2f2f7; }
    .menu-list-item:last-child { border-bottom: none; }
    
    .invite-box { background: linear-gradient(90deg, #5856D6, #AF52DE); margin: 0 20px 20px; padding: 24px; border-radius: 16px; color: white; cursor: pointer; position: relative; overflow: hidden; }
    .invite-box:active { transform: scale(0.98); }

    /* SHEET */
    .sheet-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 100;
      opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .sheet-overlay.active { opacity: 1; pointer-events: auto; }
    
    .bottom-sheet {
      position: absolute; bottom: 0; left: 0; right: 0; height: 92%;
      background: #fff; border-radius: 30px 30px 0 0;
      transform: translateY(101%); transition: transform 0.5s var(--ease-spring);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
    }
    .sheet-overlay.active .bottom-sheet { transform: translateY(0); }
    
    .sheet-handle-area { width: 100%; height: 30px; position: absolute; top: 0; display: flex; justify-content: center; padding-top: 10px; cursor: grab; z-index: 20; }
    .sheet-handle { width: 40px; height: 5px; background: rgba(255,255,255,0.8); border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    
    .sheet-cover { height: 240px; width: 100%; background-size: cover; background-position: center; position: relative; flex-shrink: 0; }
    .sheet-close { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; background: rgba(0,0,0,0.5); border-radius: 50%; color: #fff; display: grid; place-items: center; cursor: pointer; backdrop-filter: blur(4px); z-index: 30; }

    .sheet-scroll-area { overflow-y: auto; flex: 1; padding: 24px; padding-bottom: 100px; }
    
    .sheet-title-lg { font-size: 28px; font-weight: 800; margin-bottom: 8px; color: var(--text-main); }
    .sheet-tags { display: flex; gap: 8px; font-size: 13px; color: var(--text-sub); margin-bottom: 20px; align-items: center; }
    .rating-badge { background: #000; color: #fff; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 12px; margin-right: 6px; }

    .h-section { margin-bottom: 30px; }
    .h-title { font-size: 17px; font-weight: 700; margin-bottom: 15px; color: var(--text-main); display: flex; justify-content: space-between; }
    
    .photo-scroll { display: flex; gap: 12px; overflow-x: auto; padding-right: 24px; scrollbar-width: none; margin: 0 -24px; padding-left: 24px; scroll-snap-type: x mandatory; }
    .photo-item { width: 140px; height: 140px; flex-shrink: 0; border-radius: 12px; background-size: cover; background-position: center; scroll-snap-align: center; background-color: #eee; }

    .menu-row { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--divider); }
    .review-card { background: #F2F2F7; padding: 16px; border-radius: 14px; margin-bottom: 12px; }
    .review-user { font-weight: 600; font-size: 14px; margin-bottom: 6px; display: flex; justify-content: space-between; }
    .review-txt { font-size: 14px; line-height: 1.5; color: #333; }
    .review-empty { color: var(--text-sub); font-size: 14px; background: #f7f7fb; padding: 14px; border-radius: 12px; }
    .review-form { background: #f7f7fb; padding: 16px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.04); }
    .review-form h4 { margin: 0 0 10px; font-size: 15px; font-weight: 700; color: var(--text-main); }
    .review-form label { display: block; font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; }
    .review-form textarea, .review-form input, .review-form select {
      width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e5e5ea; font-size: 14px;
      font-family: inherit; margin-bottom: 12px; background: #fff;
    }
    .review-form button {
      width: 100%; background: #000; color: #fff; border: none; padding: 14px; border-radius: 12px;
      font-size: 15px; font-weight: 700; cursor: pointer; transition: transform 0.1s;
    }
    .review-form button:active { transform: scale(0.98); }
    .rating-inputs { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .rating-pill { padding: 6px 10px; background: #fff; border-radius: 10px; border: 1px solid #e5e5ea; cursor: pointer; font-weight: 700; font-size: 13px; }
    .rating-pill.active { background: var(--accent); border-color: var(--accent); color: #fff; box-shadow: 0 6px 14px rgba(0,122,255,0.25); }

    .sheet-fab { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 16px 24px 34px; border-top: 1px solid rgba(0,0,0,0.05); }
    .btn-primary { width: 100%; background: #000; color: #fff; border: none; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: transform 0.1s; }
    .btn-primary:active { transform: scale(0.98); }

    /* QR MODAL */
    .qr-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(8px); }
    .qr-modal.active { opacity: 1; pointer-events: auto; }
    .qr-card { background: #fff; width: 300px; border-radius: 24px; padding: 30px; text-align: center; transform: scale(0.8); transition: transform 0.5s var(--ease-spring); }
    .qr-modal.active .qr-card { transform: scale(1); }

    /* NAV */
    .tab-bar { position: absolute; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: rgba(255, 255, 255, 0.95); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; padding-top: 12px; padding-bottom: 20px; z-index: 90; }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #999; transition: all 0.2s; cursor: pointer; }
    .tab-item.active { color: var(--text-main); }
    .tab-icon { font-size: 26px; transition: transform 0.3s var(--ease-spring); }
    .tab-item.active .tab-icon { transform: translateY(-3px); }
    .tab-label { font-size: 10px; font-weight: 600; }

    /* UTILS */
    .view { display: none; height: 100%; flex: 1 1 auto; min-height: 0; }
    .view.active { display: flex; flex-direction: column; animation: fadeIn 0.4s var(--ease-spring); }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    
    .fade-in-up { animation: fadeInUp 0.6s var(--ease-spring) backwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

  </style>
</head>
<body>

  <div class="app-container">
    <div id="view-explore" class="view active">
      <header class="app-header">
        <div class="app-title">Discover</div>
        <div style="font-size: 22px; color: var(--accent);">&#128269;</div>
      </header>

      <div class="view-content">
        <div class="search-wrapper">
          <input type="text" id="exploreSearch" class="search-input" placeholder="Search venues, food..." oninput="filterExplore()" />
        </div>

        <div class="filter-scroll" id="exploreFilters">
          <div class="chip active" onclick="setExploreFilter('all', this)">All</div>
          <div class="chip" onclick="setExploreFilter('coffee', this)">&#9749; Coffee</div>
          <div class="chip" onclick="setExploreFilter('burger', this)">&#127828; Burger</div>
          <div class="chip" onclick="setExploreFilter('healthy', this)">&#127811; Healthy</div>
          <div class="chip" onclick="setExploreFilter('pizza', this)">&#127829; Pizza</div>
          <div class="chip" onclick="setExploreFilter('sushi', this)">&#127843; Sushi</div>
        </div>

        <div class="map-wrapper">
          <div id="explore-map"></div>
          <div class="map-toast">Search filters update the map</div>
          <div class="map-legend"><span class="legend-dot"></span>Tap a pin to open details</div>
        </div>

        <div class="section-title">Trending Near You</div>

        <div id="explore-list"></div>

        <div style="height: 40px;"></div>
      </div>
    </div>

    <div id="view-wallet" class="view">
      <header class="app-header">
        <div class="app-title">Wallet</div>
        <div style="font-size: 22px; color: var(--accent);">&#128179;</div>
      </header>
      
      <div class="view-content">
        <div class="search-wrapper">
          <input type="text" id="walletSearch" class="search-input" placeholder="Search passes..." onkeyup="renderWallet()" />
        </div>

        <div class="filter-scroll" id="walletFilters">
          <div class="chip active" onclick="filterType(this, 'all')">All</div>
          <div class="chip" onclick="filterType(this, 'coffee')">&#9749; Coffee</div>
          <div class="chip" onclick="filterType(this, 'restaurant')">&#127828; Food</div>
          <div class="chip" onclick="filterType(this, 'pt')">&#127477;&#127481; PT</div>
          <div class="chip" onclick="filterType(this, 'es')">&#127466;&#127480; ES</div>
        </div>

        <div id="wallet-content">
          <div id="fav-list"></div>
          
          <div class="section-subtitle">Other Cards</div>
          <div id="stack-list" class="wallet-stack-wrapper" onclick="toggleStack()"></div>
          <div style="text-align:center; color:#ccc; font-size:12px; margin-top:20px; opacity:0.6;">Tap stack to expand</div>
        </div>
      </div>
    </div>

    <div id="view-profile" class="view">
      <header class="app-header">
        <div class="app-title">Profile</div>
        <div style="font-size: 22px; color: var(--accent);">&#128100;</div>
      </header>
      
      <div class="view-content">
        <div class="profile-header">
          <div class="profile-pic" style="background-image: url('https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?auto=format&fit=crop&w=200&q=80');"></div>
          <h2 style="margin: 0; font-size: 22px; font-weight:700;">John Doe</h2>
          <p style="margin: 4px 0 0; color: var(--text-sub); font-size: 14px;">john.doe@example.com</p>
        </div>

        <div class="invite-box" onclick="alert('Link copiado!')">
          <div style="font-weight: 700; font-size: 18px; margin-bottom: 6px;">&#127873; Give 100, Get 100</div>
          <div style="font-size: 14px; opacity: 0.95; line-height: 1.4;">Invite your friends to Tasty Passport. You both earn points on their first visit.</div>
          <div style="margin-top: 16px; font-size: 13px; font-weight: 700; text-decoration: underline;">Share Invite Link</div>
        </div>

        <div class="menu-list">
          <div class="menu-list-item">
            <span>Account Details</span><span style="color: var(--text-sub);">&#8250;</span>
          </div>
          <div class="menu-list-item">
            <span>Payment Methods</span><span style="color: var(--text-sub);">&#8250;</span>
          </div>
          <div class="menu-list-item">
            <span>History</span><span style="color: var(--text-sub);">&#8250;</span>
          </div>
          <div class="menu-list-item">
            <span>Notifications</span><span style="color: var(--accent);">On</span>
          </div>
          <div class="menu-list-item">
            <span>Help & Support</span><span style="color: var(--text-sub);">&#8250;</span>
          </div>
        </div>
        
        <div style="text-align: center; color: var(--text-sub); font-size: 12px; margin-top: 20px;">
          Tasty Passport v2.1 (1 Fav + Stack)
        </div>
      </div>
    </div>

    <nav class="tab-bar">
      <div class="tab-item active" onclick="switchTab('explore', this)">
        <span class="tab-icon">&#128269;</span><span class="tab-label">Explore</span>
      </div>
      <div class="tab-item" onclick="switchTab('wallet', this)">
        <span class="tab-icon">&#128179;</span><span class="tab-label">Wallet</span>
      </div>
      <div class="tab-item" onclick="switchTab('profile', this)">
        <span class="tab-icon">&#128100;</span><span class="tab-label">Profile</span>
      </div>
    </nav>

    <div class="sheet-overlay" id="venueSheet" onclick="closeSheet()">
      <div class="bottom-sheet" id="sheetEl" onclick="event.stopPropagation()">
        <div class="sheet-handle-area" id="dragHandle"><div class="sheet-handle"></div></div>
        
        <div class="sheet-cover" id="sheetCover">
          <div class="sheet-close" onclick="closeSheet()">&#10005;</div>
        </div>
        
        <div class="sheet-scroll-area">
            <h1 class="sheet-title-lg" id="sheetTitle">Venue Name</h1>
            <div class="sheet-tags" id="sheetTags"></div>
            <p style="font-size: 15px; color: #3A3A3C; line-height: 1.6; margin-bottom: 24px;" id="sheetDescription">
              Discover new places with Tasty Passport and unlock better perks the more you go.
            </p>

            <div class="h-section">
              <div class="h-title">Photos</div>
              <div class="photo-scroll" id="sheetPhotos"></div>
            </div>

            <div class="h-section">
              <div class="h-title">
                <span>Popular Items</span>
                <span id="sheetMenuCta" style="font-size:14px; color:var(--accent); font-weight:500;">See Menu</span>
              </div>
              <div id="sheetMenu"></div>
            </div>

            <div class="h-section">
              <div class="h-title">
                <span>Reviews</span>
                <span style="font-size:14px; color:var(--accent); font-weight:500; cursor:pointer;" onclick="focusReviewForm()">Write Review</span>
              </div>
              <div id="sheetReviews"></div>
              <div class="review-form" id="reviewForm">
                <h4>Add your review</h4>
                <label>Rating</label>
                <div class="rating-inputs" id="ratingInputs">
                  <span class="rating-pill active" data-value="5">5&#9733;</span>
                  <span class="rating-pill" data-value="4">4&#9733;</span>
                  <span class="rating-pill" data-value="3">3&#9733;</span>
                </div>
                <label for="reviewName">Name</label>
                <input type="text" id="reviewName" placeholder="Your name (optional)" />
                <label for="reviewText">Your thoughts</label>
                <textarea id="reviewText" rows="3" placeholder="Share a quick line..." required></textarea>
                <button onclick="addReview(event)">Submit review</button>
              </div>
            </div>
        </div>

        <div class="sheet-fab">
          <button class="btn-primary" onclick="openQR(event, 'Venue Name')">
            <span>&#128273;</span> Show Member Pass
          </button>
        </div>
      </div>
    </div>

    <div class="qr-modal" id="qrModal" onclick="closeQR()">
      <div class="qr-card" onclick="event.stopPropagation()">
        <h2 id="qrTitle" style="margin:0 0 5px;">Member Pass</h2>
        <p style="color:#888; margin-top:0;">Scan to earn points</p>
        <div style="width:200px; height:200px; margin:20px auto; background: url('https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=TastyPassportUser') center/cover;"></div>
        <div style="font-size:32px; font-weight:800; letter-spacing:4px;">928 110</div>
        <button onclick="closeQR()" style="margin-top:20px; width:100%; padding:14px; background:#F2F2F7; border:none; border-radius:12px; font-weight:600; font-size:15px;">Close</button>
      </div>
    </div>

  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-p3x0Z8yXk+jgwyU0vbzUKGwEuKXXSb9VjA36TObgGJE0E7E5Wdl66iRS0LlwM651c01qmPvvrL1jLxPQxI+3pA==" crossorigin=""></script>
  <script>
    // --- DATA ---
    const exploreVenues = [
      {
        id: 'coffee-spot',
        name: 'The Coffee Spot',
        type: 'coffee',
        vibe: 'Specialty coffee',
        distance: '0.8 km',
        price: '$$',
        rating: 4.9,
        status: 'Open until 6 PM',
        cover: 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?auto=format&fit=crop&w=600&q=80',
        coords: [38.7223, -9.1393],
        photos: [
          'https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&w=200&q=80',
          'https://images.unsplash.com/photo-1511920170033-f8396924c348?auto=format&fit=crop&w=200&q=80',
          'https://images.unsplash.com/photo-1559339352-11d035aa65de?auto=format&fit=crop&w=200&q=80'
        ],
        menu: [
          { name: 'Cappuccino', price: '&euro;3.50' },
          { name: 'Avocado Toast', price: '&euro;8.90' },
          { name: 'Cold Brew', price: '&euro;4.20' }
        ],
        reviews: [
          { user: 'Alice M.', rating: 5, text: 'Best coffee in town! Rewards system is super easy to use.' },
          { user: 'Tom H.', rating: 4, text: 'Great vibe, a bit crowded on weekends but worth the wait.' }
        ],
        description: 'Warm space in the heart of the city. Perfect to work or meet friends.',
        perk: 'Welcome perk: 15% off first visit'
      },
      {
        id: 'burger-joint',
        name: 'Burger Joint LX',
        type: 'burger',
        vibe: 'Smash burgers & fries',
        distance: '1.2 km',
        price: '$$',
        rating: 4.5,
        status: 'Open until 11 PM',
        cover: 'https://images.unsplash.com/photo-1561758033-d8f19662cb23?auto=format&fit=crop&w=600&q=80',
        coords: [38.716, -9.142],
        photos: [
          'https://images.unsplash.com/photo-1561758033-d8f19662cb23?auto=format&fit=crop&w=200&q=80',
          'https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=200&q=80'
        ],
        menu: [
          { name: 'Double smash', price: '$9.50' },
          { name: 'Truffle fries', price: '$4.50' }
        ],
        reviews: [
          { user: 'Luis F.', rating: 5, text: 'Juicy burgers and quick service.' },
          { user: 'Sara T.', rating: 4, text: 'Loved the smash patty, wish there were more veggie options.' }
        ],
        description: 'Casual burger joint with late hours and generous perks for members.',
        perk: 'Skip-the-line perk for members'
      },
      {
        id: 'green-salad',
        name: 'Green Salad Bar',
        type: 'healthy',
        vibe: 'Bowls & smoothies',
        distance: '0.4 km',
        price: '$$',
        rating: 4.7,
        status: 'Open until 8 PM',
        cover: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?auto=format&fit=crop&w=600&q=80',
        coords: [38.728, -9.135],
        photos: [
          'https://images.unsplash.com/photo-1554118811-1e0d58224f24?auto=format&fit=crop&w=200&q=80',
          'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=200&q=80'
        ],
        menu: [
          { name: 'Protein bowl', price: '$11.00' },
          { name: 'Green smoothie', price: '$5.50' }
        ],
        reviews: [
          { user: 'Ines P.', rating: 5, text: 'Fresh ingredients and quick rewards.' }
        ],
        description: 'Colorful, healthy bowls perfect for a lunch break.',
        perk: 'Free topping on second visit'
      },
      {
        id: 'trastevere-slice',
        name: 'Trastevere Slice',
        type: 'pizza',
        vibe: 'Roman-style pizza',
        distance: '0.9 km',
        price: '$$',
        rating: 4.6,
        status: 'Open until 10 PM',
        cover: 'https://images.unsplash.com/photo-1601924994987-69e26d50dc26?auto=format&fit=crop&w=600&q=80',
        coords: [38.719, -9.132],
        photos: [
          'https://images.unsplash.com/photo-1601924994987-69e26d50dc26?auto=format&fit=crop&w=200&q=80',
          'https://images.unsplash.com/photo-1548365328-8b010ac56d83?auto=format&fit=crop&w=200&q=80'
        ],
        menu: [
          { name: 'Margherita slice', price: '$3.80' },
          { name: 'Diavola slice', price: '$4.20' }
        ],
        reviews: [
          { user: 'Paolo R.', rating: 5, text: 'Crispy crust and generous toppings.' }
        ],
        description: 'Roman-style pizza al taglio with rotating seasonal specials.',
        perk: 'Free drink on third visit'
      },
      {
        id: 'sora-sushi',
        name: 'Sora Sushi',
        type: 'sushi',
        vibe: 'Modern Japanese',
        distance: '1.5 km',
        price: '$$$',
        rating: 4.8,
        status: 'Open until 11 PM',
        cover: 'https://images.unsplash.com/photo-1553621042-f6e147245754?auto=format&fit=crop&w=600&q=80',
        coords: [38.714, -9.149],
        photos: [
          'https://images.unsplash.com/photo-1553621042-f6e147245754?auto=format&fit=crop&w=200&q=80',
          'https://images.unsplash.com/photo-1544378730-8b5104b6fcde?auto=format&fit=crop&w=200&q=80'
        ],
        menu: [
          { name: 'Salmon nigiri set', price: '$12.00' },
          { name: 'Spicy tuna roll', price: '$9.00' }
        ],
        reviews: [
          { user: 'Mayumi K.', rating: 5, text: 'Fresh fish and a calm vibe, perfect for dates.' }
        ],
        description: 'Bright sushi bar with omakase nights and curated sake.',
        perk: 'Complimentary miso on first visit'
      }
    ];

    const cards = [
      { id: 1, name: 'The Coffee Spot', icon: '&#9749;', type: 'coffee', country: 'pt', tier: 'GOLD', color: 'gold', points: 850, max: 1000 },
      { id: 2, name: 'Burger Joint LX', icon: '&#127828;', type: 'restaurant', country: 'pt', tier: 'REGULAR', color: 'blue', points: 120, max: 500 },
      { id: 3, name: 'Trastevere Slice', icon: '&#127829;', type: 'restaurant', country: 'pt', tier: 'SILVER', color: 'red', points: 300, max: 600 },
      { id: 4, name: 'Green Salad Bar', icon: '&#127811;', type: 'restaurant', country: 'pt', tier: 'STARTER', color: 'green', points: 50, max: 200 },
      { id: 5, name: 'Sora Sushi', icon: '&#127843;', type: 'restaurant', country: 'es', tier: 'PLATINUM', color: 'purple', points: 950, max: 1000 }
    ];

    let walletFilter = 'all';
    let exploreFilter = 'all';
    let activeVenueId = null;
    let map;
    let mapMarkers = [];

    // WALLET LOGIC
    function renderWallet() {
      const search = document.getElementById('walletSearch').value.toLowerCase();
      const favList = document.getElementById('fav-list');
      const stackList = document.getElementById('stack-list');
      
      favList.innerHTML = '';
      stackList.innerHTML = '';
      
      const filtered = cards.filter(c => {
        const matchesFilter = walletFilter === 'all' || c.type === walletFilter || c.country === walletFilter;
        const matchesSearch = c.name.toLowerCase().includes(search);
        return matchesFilter && matchesSearch;
      }).sort((a, b) => b.points - a.points);

      const favs = filtered.slice(0, 1);
      const stack = filtered.slice(1);

      if (favs.length === 0) {
        favList.innerHTML = '<div style="padding:20px; color:#999;">No cards found</div>';
      } else {
        favs.forEach((c, i) => favList.innerHTML += createCard(c, false, i));
      }

      if (stack.length > 0) {
        document.querySelector('.section-subtitle').style.display = 'block';
        stack.forEach((c, i) => stackList.innerHTML += createCard(c, true, i));
      } else {
        document.querySelector('.section-subtitle').style.display = 'none';
      }

      setTimeout(() => {
        document.querySelectorAll('.progress-fill').forEach(el => el.style.width = el.getAttribute('data-width'));
      }, 100);
      stackList.classList.remove('expanded');
    }

    function createCard(c, stacked, index) {
      const pct = (c.points / c.max) * 100;
      const delay = index * 0.1;
      const stackClass = stacked ? 'stacked-card' : '';
      
      return `
        <div class="wallet-card ${c.color} ${stackClass} fade-in-up" style="animation-delay: ${delay}s" onclick="cardClick(event, '${c.name}', ${stacked})">
          <div class="card-header"><div class="card-logo">${c.icon}</div><div class="card-tier">${c.tier} MEMBER</div></div>
          <div style="font-size:20px; font-weight:800; margin-bottom:16px;">${c.name}</div>
          <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:600; opacity:0.9;"><span>Points</span><span>${c.points} / ${c.max}</span></div>
          <div class="progress-track"><div class="progress-fill" style="width:0%" data-width="${pct}%"></div></div>
          <div style="font-size:11px; opacity:0.7; margin-top:10px;">Tap to show QR</div>
        </div>
      `;
    }

    function filterType(el, type) {
      document.querySelectorAll('#walletFilters .chip').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      walletFilter = type;
      renderWallet();
    }
    function toggleStack() { document.getElementById('stack-list').classList.toggle('expanded'); }
    function cardClick(e, name, stacked) {
      e.stopPropagation();
      if (stacked && !document.getElementById('stack-list').classList.contains('expanded')) { toggleStack(); } 
      else { openQR(e, name); }
    }

    // EXPLORE LOGIC
    function renderExplore() {
      const filtered = getFilteredVenues();
      renderExploreList(filtered);
      updateMapMarkers(filtered);
    }

    function getFilteredVenues() {
      const q = document.getElementById('exploreSearch').value.toLowerCase();
      return exploreVenues.filter(v => {
        const matchesType = exploreFilter === 'all' || v.type === exploreFilter;
        const matchesText = v.name.toLowerCase().includes(q) || v.vibe.toLowerCase().includes(q) || v.description.toLowerCase().includes(q);
        return matchesType && matchesText;
      });
    }

    function renderExploreList(list) {
      const listEl = document.getElementById('explore-list');
      if (!list.length) {
        listEl.innerHTML = '<div style="padding:20px; color:#8E8E93;">No venues match your filters yet.</div>';
        return;
      }

      listEl.innerHTML = list.map((v) => `
        <div class="venue-card" onclick="openProfile('${v.id}')">
          <div class="venue-img" style="background-image: url('${v.cover}')">
            <div class="card-qr-btn" onclick="openQR(event, '${v.name}')"><span style="font-size:20px; color:white;">&#128273;</span></div>
          </div>
          <div class="venue-details">
            <div class="venue-row">
              <span class="venue-name">${v.name}</span>
              <span style="color: var(--accent-gold); font-weight: 700;">&#9733; ${v.rating.toFixed(1)}</span>
            </div>
            <div class="venue-meta">${v.vibe} &bull; ${v.distance} &bull; ${v.price}</div>
          </div>
        </div>
      `).join('');
    }

    function setExploreFilter(type, el) {
      exploreFilter = type;
      document.querySelectorAll('#exploreFilters .chip').forEach(chip => chip.classList.remove('active'));
      if (el) el.classList.add('active');
      renderExplore();
    }

    function filterExplore() { renderExplore(); }

    function initMap() {
      map = L.map('explore-map', { zoomControl: false }).setView([38.7223, -9.1393], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      renderExplore();
    }

    function updateMapMarkers(list) {
      if (!map) return;
      mapMarkers.forEach(marker => marker.remove());
      mapMarkers = [];

      if (!list.length) {
        map.setView([38.7223, -9.1393], 13);
        return;
      }

      const bounds = [];
      list.forEach(v => {
        const marker = L.circleMarker(v.coords, { radius: 10, color: '#007AFF', weight: 2, fillColor: '#fff', fillOpacity: 1 });
        marker.bindPopup(`<strong>${v.name}</strong><br>${v.vibe} &bull; ${v.distance}`);
        marker.on('click', () => openProfile(v.id));
        marker.addTo(map);
        mapMarkers.push(marker);
        bounds.push(v.coords);
      });

      if (bounds.length === 1) {
        map.setView(bounds[0], 15);
      } else {
        map.fitBounds(bounds, { padding: [20, 20] });
      }
    }

    // SHEET MODAL LOGIC
    function openProfile(id) {
      const venue = exploreVenues.find(v => v.id === id || v.name === id) || exploreVenues[0];
      activeVenueId = venue.id;

      document.getElementById('sheetTitle').innerText = venue.name;
      document.getElementById('sheetCover').style.backgroundImage = `url('${venue.cover}')`;
      document.getElementById('sheetTags').innerHTML = `<span class="rating-badge">&#9733; ${venue.rating.toFixed(1)}</span><span>${venue.vibe}</span> &bull; <span>${venue.status}</span>`;
      document.getElementById('sheetDescription').innerText = venue.description || 'Spot description coming soon.';

      renderPhotos(venue);
      renderMenu(venue);
      renderReviews(venue);
      setDefaultRating();
      document.getElementById('venueSheet').classList.add('active');
    }

    function renderPhotos(venue) {
      const el = document.getElementById('sheetPhotos');
      if (!venue.photos || !venue.photos.length) {
        el.innerHTML = '<div class="review-empty">Photos coming soon.</div>';
        return;
      }
      el.innerHTML = venue.photos.map(url => `<div class="photo-item" style="background-image: url('${url}')"></div>`).join('');
    }

    function renderMenu(venue) {
      const el = document.getElementById('sheetMenu');
      if (!venue.menu || !venue.menu.length) {
        el.innerHTML = '<div class="review-empty">Menu coming soon.</div>';
        return;
      }
      document.getElementById('sheetMenuCta').innerText = venue.perk || 'See Menu';
      el.innerHTML = venue.menu.map(item => `<div class="menu-row"><span>${item.name}</span><span style="color:#8E8E93;">${item.price}</span></div>`).join('');
    }

    function renderReviews(venue) {
      const el = document.getElementById('sheetReviews');
      if (!venue.reviews || !venue.reviews.length) {
        el.innerHTML = '<div class="review-empty">No reviews yet. Be the first!</div>';
        return;
      }
      el.innerHTML = venue.reviews.map(r => {
        const filled = '&#9733;'.repeat(r.rating);
        const empty = '&#9734;'.repeat(5 - r.rating);
        return `<div class="review-card"><div class="review-user"><span>${r.user}</span><span style="color:#FFD60A;">${filled}${empty}</span></div><div class="review-txt">${r.text}</div></div>`;
      }).join('');
    }

    function addReview(event) {
      if (event) event.preventDefault();
      if (!activeVenueId) return;
      const venue = exploreVenues.find(v => v.id === activeVenueId);
      if (!venue) return;

      const name = document.getElementById('reviewName').value.trim() || 'Guest';
      const text = document.getElementById('reviewText').value.trim();
      const ratingPill = document.querySelector('.rating-pill.active');
      const rating = ratingPill ? parseInt(ratingPill.dataset.value, 10) : 5;

      if (!text) return;

      venue.reviews.unshift({ user: name, rating, text });
      document.getElementById('reviewText').value = '';
      document.getElementById('reviewName').value = '';
      renderReviews(venue);
      setDefaultRating();
      focusReviewForm();
    }

    function focusReviewForm() {
      const form = document.getElementById('reviewForm');
      if (form) {
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        const textarea = document.getElementById('reviewText');
        if (textarea) textarea.focus();
      }
    }

    function setDefaultRating(value = 5) {
      document.querySelectorAll('.rating-pill').forEach(pill => {
        pill.classList.toggle('active', parseInt(pill.dataset.value, 10) === value);
      });
    }

    // NAVIGATION
    function switchTab(id, el) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById('view-' + id).classList.add('active');
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      if (id === 'explore' && map) {
        setTimeout(() => map.invalidateSize(), 150);
      }
    }

    function closeSheet() { document.getElementById('venueSheet').classList.remove('active'); }

    // QR LOGIC
    function openQR(e, name) {
      if (e) e.stopPropagation();
      const fallback = document.getElementById('sheetTitle').innerText;
      const title = name && name !== 'Venue Name' ? name : fallback;
      document.getElementById('qrTitle').innerText = title;
      document.getElementById('qrModal').classList.add('active');
    }
    function closeQR() { document.getElementById('qrModal').classList.remove('active'); }

    // DRAG TO CLOSE
    const handle = document.getElementById('dragHandle');
    const sheet = document.getElementById('sheetEl');
    let startY = 0;
    handle.addEventListener('touchstart', e => { startY = e.touches[0].clientY; });
    handle.addEventListener('touchmove', e => {
      let diff = e.touches[0].clientY - startY;
      if (diff > 0) sheet.style.transform = `translateY(${diff}px)`;
    });
    handle.addEventListener('touchend', e => {
      let diff = e.changedTouches[0].clientY - startY;
      sheet.style.transform = '';
      if (diff > 100) closeSheet();
    });

    document.querySelectorAll('.rating-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.rating-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
      });
    });

    // START
    initMap();
    renderWallet();
    setDefaultRating();
  </script>
</body>
</html>
